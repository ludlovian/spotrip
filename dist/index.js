#!/usr/bin/env node
"use strict";function t(t){return t&&"object"==typeof t&&"default"in t?t.default:t}var e=require("path"),n=require("fs"),a=t(n),r=t(require("stream")),i=t(require("http")),s=require("child_process"),o=require("util"),c=t(require("events"));function l(t){return null==t?[]:Array.isArray(t)?t:[t]}function u(t,e,n,a){var r,i=t[e],s=~a.string.indexOf(e)?null==n||!0===n?"":String(n):"boolean"==typeof n?n:~a.boolean.indexOf(e)?"false"!==n&&("true"===n||(t._.push(0*(r=+n)==0?r:n),!!n)):0*(r=+n)==0?r:n;t[e]=null==i?s:Array.isArray(i)?i.concat(s):[i,s]}var d=function(t,e){e=e||{};var n,a,r,i,s,o={_:[]},c=0,d=0,f=0,h=(t=t||[]).length;const m=void 0!==e.alias,p=void 0!==e.unknown,g=void 0!==e.default;if(e.alias=e.alias||{},e.string=l(e.string),e.boolean=l(e.boolean),m)for(n in e.alias)for(a=e.alias[n]=l(e.alias[n]),c=0;c<a.length;c++)(e.alias[a[c]]=a.concat(n)).splice(c,1);if(e.boolean.forEach(t=>{e.boolean=e.boolean.concat(e.alias[t]=e.alias[t]||[])}),e.string.forEach(t=>{e.string=e.string.concat(e.alias[t]=e.alias[t]||[])}),g)for(n in e.default)e.alias[n]=e.alias[n]||[],(e[typeof e.default[n]]||[]).push(n);const b=p?Object.keys(e.alias):[];for(c=0;c<h;c++){if("--"===(r=t[c])){o._=o._.concat(t.slice(++c));break}for(d=0;d<r.length&&45===r.charCodeAt(d);d++);if(0===d)o._.push(r);else if("no-"===r.substring(d,d+3)){if(i=r.substring(d+3),p&&!~b.indexOf(i))return e.unknown(r);o[i]=!1}else{for(f=d+1;f<r.length&&61!==r.charCodeAt(f);f++);for(i=r.substring(d,f),s=r.substring(++f)||c+1===h||45===(""+t[c+1]).charCodeAt(0)||t[++c],a=2===d?[i]:i,f=0;f<a.length;f++){if(i=a[f],p&&!~b.indexOf(i))return e.unknown("-".repeat(d)+i);u(o,i,f+1<a.length||s,e)}}}if(g)for(n in e.default)void 0===o[n]&&(o[n]=e.default[n]);if(m)for(n in o)for(a=e.alias[n]||[];a.length>0;)o[a.shift()]=o[n];return o};const f="  ",h="__default__",m="\n";function p(t){if(!t.length)return"";let e=function(t){let e=0,n=0,a=0,r=t.length;if(r)for(;r--;)n=t[r].length,n>e&&(a=r,e=n);return t[a].length}(t.map(t=>t[0]))+4;return t.map(t=>t[0]+" ".repeat(e-t[0].length)+t[1]+(null==t[2]?"":`  (default ${t[2]})`))}function g(t){return t}function b(t,e,n){if(!e||!e.length)return"";let a=0,r="";for(r+=m+f+t;a<e.length;a++)r+="\n    "+n(e[a]);return r+m}var w=function(t,e,n,a){let r="",i=e[n],s=`$ ${t}`,o=e.__all__,c=t=>`${s} ${t}`.replace(/\s+/g," "),l=[["-h, --help","Displays this message"]];if(n===h&&l.unshift(["-v, --version","Displays current version"]),i.options=(i.options||[]).concat(o.options,l),i.options.length>0&&(i.usage+=" [options]"),r+=b("Description",i.describe,g),r+=b("Usage",[i.usage],c),a||n!==h)a||n===h||(r+=b("Aliases",i.alibi,c));else{let t=Object.keys(e).filter(t=>!/__/.test(t)),n=t.map(t=>[t,(e[t].describe||[""])[0]]);r+=b("Available Commands",p(n),g),r+="\n  For more info, run any command with the `--help` flag",t.slice(0,2).forEach(t=>{r+="\n    "+`${s} ${t} --help`}),r+=m}return r+=b("Options",p(i.options),g),r+=b("Examples",i.examples.map(c),g),r},y=function(t,e,n=1){let a=b("ERROR",[e],g);a+=m+f+`Run \`$ ${t} --help\` for more info.`+m,console.error(a),process.exit(n)},k=function(t){return(t||"").split(/^-{1,2}|,|\s+-{1,2}|\s+/).filter(Boolean)},v=function(t){return(t||"").replace(/([.?!])\s*(?=[A-Z])/g,"$1|").split("|")};const $="__default__";class A{constructor(t,e){let[n,...a]=t.split(/\s+/);e=e||a.length>0,this.bin=n,this.ver="0.0.0",this.default="",this.tree={},this.command("__all__"),this.command([$].concat(e?a:"<command>").join(" ")),this.single=e,this.curr=""}command(t,e,n={}){if(this.single)throw new Error('Disable "single" mode to add commands');let a=[],r=[],i=/(\[|<)/;if(t.split(/\s+/).forEach(t=>{(i.test(t.charAt(0))?r:a).push(t)}),a=a.join(" "),a in this.tree)throw new Error(`Command already exists: ${a}`);return a.includes("__")||r.unshift(a),r=r.join(" "),this.curr=a,n.default&&(this.default=a),this.tree[a]={usage:r,alibi:[],options:[],alias:{},default:{},examples:[]},n.alias&&this.alias(n.alias),e&&this.describe(e),this}describe(t){return this.tree[this.curr||$].describe=Array.isArray(t)?t:v(t),this}alias(...t){if(this.single)throw new Error('Cannot call `alias()` in "single" mode');if(!this.curr)throw new Error("Cannot call `alias()` before defining a command");return this.tree[this.curr].alibi=this.tree[this.curr].alibi.concat(...t),this}option(t,e,n){let a=this.tree[this.curr||"__all__"],[r,i]=k(t);if(i&&i.length>1&&([r,i]=[i,r]),t=`--${r}`,i&&i.length>0){t=`-${i}, ${t}`;let e=a.alias[i];a.alias[i]=(e||[]).concat(r)}let s=[t,e||""];return void 0!==n?(s.push(n),a.default[r]=n):i||(a.default[r]=void 0),a.options.push(s),this}action(t){return this.tree[this.curr||$].handler=t,this}example(t){return this.tree[this.curr||$].examples.push(t),this}version(t){return this.ver=t,this}parse(t,e={}){let n,a,r,i=2,s=d(t.slice(i),{alias:{h:"help",v:"version"}}),o=this.single,c=this.bin,l="";if(o)r=this.tree[$];else{let e,o=1,u=s._.length+1;for(;o<u;o++)if(n=s._.slice(0,o).join(" "),void 0!==this.tree[n])l=n,i=o+2;else for(e in this.tree)if(this.tree[e].alibi.includes(n)){l=e,i=o+2;break}if(r=this.tree[l],a=void 0===r,a)if(this.default)l=this.default,r=this.tree[l],t.unshift(l),i++;else if(n)return y(c,`Invalid command: ${n}`)}if(s.help)return this.help(!o&&!a&&l);if(s.version)return this._version();if(!o&&void 0===r)return y(c,"No command specified.");let u=this.tree.__all__;e.alias=Object.assign(u.alias,r.alias,e.alias),e.default=Object.assign(u.default,r.default,e.default);let f=d(t.slice(i),e);if(!f||"string"==typeof f)return y(c,f||"Parsed unknown option flag(s)!");let h=r.usage.split(/\s+/),m=h.filter(t=>"<"===t.charAt(0)),p=f._.splice(0,m.length);if(p.length<m.length)return l&&(c+=` ${l}`),y(c,"Insufficient arguments!");h.filter(t=>"["===t.charAt(0)).forEach(t=>{p.push(f._.shift())}),p.push(f);let g=r.handler;return e.lazy?{args:p,name:l,handler:g}:g.apply(null,p)}help(t){console.log(w(this.bin,this.tree,t||$,this.single))}_version(){console.log(`${this.bin}, ${this.ver}`)}}function E(t,e={}){return function t(e){const{fn:n,attempt:a,retries:r=10,delay:i=1e3,backoff:s=E.exponential(1.5),onRetry:o}=e;return new Promise(t=>t(n())).catch(n=>{if(a>r)throw n;return o&&o({error:n,attempt:a,delay:i}),x(i).then(()=>t({...e,attempt:a+1,delay:s(i)}))})}({...e,fn:t,attempt:1})}E.exponential=t=>e=>Math.round(e*t);const x=t=>new Promise(e=>setTimeout(e,t));var O=E;var j=function(t={}){const{onProgress:e,progressInterval:n,...a}=t;let i,s,o=0,c=!1;const l=new r.Transform({transform(t,e,n){o+=t.length,n(null,t)},flush(t){i&&clearInterval(i),c=!0,u(),t(s)}});return n&&(i=setInterval(u,n)),"function"==typeof e&&l.on("progress",e),l.on("pipe",t=>t.on("error",t=>{s=s||t,l.emit("error",t)})),l;function u(){s||l.emit("progress",{bytes:o,done:c,...a})}};var S=class{constructor({window:t=10}={}){this.windowSize=t,this.start=Date.now(),this.readings=[[this.start,0]]}update(t){"number"==typeof t&&(t={current:t});const{current:e,total:n}=t;n&&(this.total=n),this.readings=[...this.readings,[Date.now(),e]].slice(-this.windowSize),this.current=e}get done(){return this.total&&this.current>=this.total}rate(){if(this.readings.length<2)return 0;if(this.done)return 1e3*this.current/this.taken();const t=this.readings[this.readings.length-1],e=this.readings[0];return 1e3*(t[1]-e[1])/(t[0]-e[0])}percent(){return this.total?this.done?100:Math.round(100*this.current/this.total):null}eta(){if(!this.total||this.done)return 0;const t=this.rate();return t?1e3*(this.total-this.current)/t:0}taken(){return this.readings[this.readings.length-1][0]-this.start}};const T=o.promisify(r.pipeline),_=o.promisify(s.execFile),C=a.promises.writeFile,R=a.promises.readFile,U=a.promises.readdir,I=a.promises.stat,N=/^[a-zA-Z0-9]{22}$/;function M(t,e){const n=t.replace(/.*[:/]/,"");if(!N.test(n))throw new Error(`Bad URI: ${t}`);return`spotify:${e}:${n}`}async function L(t){const e=await R(t,{encoding:"utf8"});return JSON.parse(e)}async function Y(t){try{return await I(t),!0}catch(t){return!1}}const B=new class{set(t){Object.assign(this,t)}};async function D(t){const e=await J(t);e.setEncoding("utf8");let n="";for await(const t of e)n+=t;return JSON.parse(n)}function J(t){return new Promise((e,n)=>{const a=B["spotweb-port"];i.get(`http://localhost:${a}${t}`,e).once("error",n).end()}).then(t=>{if(200!==t.statusCode)throw new Error(`${t.statusCode} - ${t.statusMessage}`);return t},t=>{if("ECONNREFUSED"===t.code)throw new Error("Spotweb not running");throw t})}async function z(t,e,{onProgress:a}={}){a&&a({});const r=await D(`/track/${t}`),i=new S(60);i.total=1+r.duration/1e3;const s=await function(t){return J(t)}(`/play/${t}`),o=j({progressInterval:1e3,onProgress({bytes:t,done:e}){const n=t/176400;i.update(n),e&&(i.total=n),a&&a({done:e,curr:n,taken:i.taken(),percent:i.percent(),total:i.total,eta:i.eta(),speed:i.rate()})}}),c=n.createWriteStream(e);await T(s,o,c);const{streamed:l,error:u}=await D("/status");if(!l||u)throw new Error(`Recording of ${t} failed: ${u}`)}async function P(t,e,n,a){a&&(await _("metaflac",["--remove","--block-type=PICTURE",t]),await _("metaflac",[`--import-picture-from=${a}`,t]));const r=[...q(e),...q(n)];await _("metaflac",["--remove-all-tags",...r.map(t=>`--set-tag=${t}`),t])}function q(t){const e=new Set(["PATH","TRACKS","FILE"]);return Object.entries(t).map(([t,e])=>[t.toUpperCase(),e]).filter(([t,n])=>!e.has(t)).map(([t,e])=>`${t}=${Array.isArray(e)?e.join(", "):e}`)}"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;var G=function(t,e){return t(e={exports:{}},e.exports),e.exports}((function(t,e){var n;n=function(){var t=JSON.parse('{"$":"dollar","%":"percent","&":"and","<":"less",">":"greater","|":"or","Â¢":"cent","Â£":"pound","Â¤":"currency","Â¥":"yen","Â©":"(c)","Âª":"a","Â®":"(r)","Âº":"o","Ã€":"A","Ã":"A","Ã‚":"A","Ãƒ":"A","Ã„":"A","Ã…":"A","Ã†":"AE","Ã‡":"C","Ãˆ":"E","Ã‰":"E","ÃŠ":"E","Ã‹":"E","ÃŒ":"I","Ã":"I","ÃŽ":"I","Ã":"I","Ã":"D","Ã‘":"N","Ã’":"O","Ã“":"O","Ã”":"O","Ã•":"O","Ã–":"O","Ã˜":"O","Ã™":"U","Ãš":"U","Ã›":"U","Ãœ":"U","Ã":"Y","Ãž":"TH","ÃŸ":"ss","Ã ":"a","Ã¡":"a","Ã¢":"a","Ã£":"a","Ã¤":"a","Ã¥":"a","Ã¦":"ae","Ã§":"c","Ã¨":"e","Ã©":"e","Ãª":"e","Ã«":"e","Ã¬":"i","Ã­":"i","Ã®":"i","Ã¯":"i","Ã°":"d","Ã±":"n","Ã²":"o","Ã³":"o","Ã´":"o","Ãµ":"o","Ã¶":"o","Ã¸":"o","Ã¹":"u","Ãº":"u","Ã»":"u","Ã¼":"u","Ã½":"y","Ã¾":"th","Ã¿":"y","Ä€":"A","Ä":"a","Ä‚":"A","Äƒ":"a","Ä„":"A","Ä…":"a","Ä†":"C","Ä‡":"c","ÄŒ":"C","Ä":"c","ÄŽ":"D","Ä":"d","Ä":"DJ","Ä‘":"dj","Ä’":"E","Ä“":"e","Ä–":"E","Ä—":"e","Ä˜":"e","Ä™":"e","Äš":"E","Ä›":"e","Äž":"G","ÄŸ":"g","Ä¢":"G","Ä£":"g","Ä¨":"I","Ä©":"i","Äª":"i","Ä«":"i","Ä®":"I","Ä¯":"i","Ä°":"I","Ä±":"i","Ä¶":"k","Ä·":"k","Ä»":"L","Ä¼":"l","Ä½":"L","Ä¾":"l","Å":"L","Å‚":"l","Åƒ":"N","Å„":"n","Å…":"N","Å†":"n","Å‡":"N","Åˆ":"n","Å":"O","Å‘":"o","Å’":"OE","Å“":"oe","Å”":"R","Å•":"r","Å˜":"R","Å™":"r","Åš":"S","Å›":"s","Åž":"S","ÅŸ":"s","Å ":"S","Å¡":"s","Å¢":"T","Å£":"t","Å¤":"T","Å¥":"t","Å¨":"U","Å©":"u","Åª":"u","Å«":"u","Å®":"U","Å¯":"u","Å°":"U","Å±":"u","Å²":"U","Å³":"u","Å´":"W","Åµ":"w","Å¶":"Y","Å·":"y","Å¸":"Y","Å¹":"Z","Åº":"z","Å»":"Z","Å¼":"z","Å½":"Z","Å¾":"z","Æ’":"f","Æ ":"O","Æ¡":"o","Æ¯":"U","Æ°":"u","Çˆ":"LJ","Ç‰":"lj","Ç‹":"NJ","ÇŒ":"nj","È˜":"S","È™":"s","Èš":"T","È›":"t","Ëš":"o","Î†":"A","Îˆ":"E","Î‰":"H","ÎŠ":"I","ÎŒ":"O","ÎŽ":"Y","Î":"W","Î":"i","Î‘":"A","Î’":"B","Î“":"G","Î”":"D","Î•":"E","Î–":"Z","Î—":"H","Î˜":"8","Î™":"I","Îš":"K","Î›":"L","Îœ":"M","Î":"N","Îž":"3","ÎŸ":"O","Î ":"P","Î¡":"R","Î£":"S","Î¤":"T","Î¥":"Y","Î¦":"F","Î§":"X","Î¨":"PS","Î©":"W","Îª":"I","Î«":"Y","Î¬":"a","Î­":"e","Î®":"h","Î¯":"i","Î°":"y","Î±":"a","Î²":"b","Î³":"g","Î´":"d","Îµ":"e","Î¶":"z","Î·":"h","Î¸":"8","Î¹":"i","Îº":"k","Î»":"l","Î¼":"m","Î½":"n","Î¾":"3","Î¿":"o","Ï€":"p","Ï":"r","Ï‚":"s","Ïƒ":"s","Ï„":"t","Ï…":"y","Ï†":"f","Ï‡":"x","Ïˆ":"ps","Ï‰":"w","ÏŠ":"i","Ï‹":"y","ÏŒ":"o","Ï":"y","ÏŽ":"w","Ð":"Yo","Ð‚":"DJ","Ð„":"Ye","Ð†":"I","Ð‡":"Yi","Ðˆ":"J","Ð‰":"LJ","ÐŠ":"NJ","Ð‹":"C","Ð":"DZ","Ð":"A","Ð‘":"B","Ð’":"V","Ð“":"G","Ð”":"D","Ð•":"E","Ð–":"Zh","Ð—":"Z","Ð˜":"I","Ð™":"J","Ðš":"K","Ð›":"L","Ðœ":"M","Ð":"N","Ðž":"O","ÐŸ":"P","Ð ":"R","Ð¡":"S","Ð¢":"T","Ð£":"U","Ð¤":"F","Ð¥":"H","Ð¦":"C","Ð§":"Ch","Ð¨":"Sh","Ð©":"Sh","Ðª":"U","Ð«":"Y","Ð¬":"","Ð­":"E","Ð®":"Yu","Ð¯":"Ya","Ð°":"a","Ð±":"b","Ð²":"v","Ð³":"g","Ð´":"d","Ðµ":"e","Ð¶":"zh","Ð·":"z","Ð¸":"i","Ð¹":"j","Ðº":"k","Ð»":"l","Ð¼":"m","Ð½":"n","Ð¾":"o","Ð¿":"p","Ñ€":"r","Ñ":"s","Ñ‚":"t","Ñƒ":"u","Ñ„":"f","Ñ…":"h","Ñ†":"c","Ñ‡":"ch","Ñˆ":"sh","Ñ‰":"sh","ÑŠ":"u","Ñ‹":"y","ÑŒ":"","Ñ":"e","ÑŽ":"yu","Ñ":"ya","Ñ‘":"yo","Ñ’":"dj","Ñ”":"ye","Ñ–":"i","Ñ—":"yi","Ñ˜":"j","Ñ™":"lj","Ñš":"nj","Ñ›":"c","Ñ":"u","ÑŸ":"dz","Ò":"G","Ò‘":"g","Ò’":"GH","Ò“":"gh","Òš":"KH","Ò›":"kh","Ò¢":"NG","Ò£":"ng","Ò®":"UE","Ò¯":"ue","Ò°":"U","Ò±":"u","Òº":"H","Ò»":"h","Ó˜":"AE","Ó™":"ae","Ó¨":"OE","Ó©":"oe","à¸¿":"baht","áƒ":"a","áƒ‘":"b","áƒ’":"g","áƒ“":"d","áƒ”":"e","áƒ•":"v","áƒ–":"z","áƒ—":"t","áƒ˜":"i","áƒ™":"k","áƒš":"l","áƒ›":"m","áƒœ":"n","áƒ":"o","áƒž":"p","áƒŸ":"zh","áƒ ":"r","áƒ¡":"s","áƒ¢":"t","áƒ£":"u","áƒ¤":"f","áƒ¥":"k","áƒ¦":"gh","áƒ§":"q","áƒ¨":"sh","áƒ©":"ch","áƒª":"ts","áƒ«":"dz","áƒ¬":"ts","áƒ­":"ch","áƒ®":"kh","áƒ¯":"j","áƒ°":"h","áº€":"W","áº":"w","áº‚":"W","áºƒ":"w","áº„":"W","áº…":"w","áºž":"SS","áº ":"A","áº¡":"a","áº¢":"A","áº£":"a","áº¤":"A","áº¥":"a","áº¦":"A","áº§":"a","áº¨":"A","áº©":"a","áºª":"A","áº«":"a","áº¬":"A","áº­":"a","áº®":"A","áº¯":"a","áº°":"A","áº±":"a","áº²":"A","áº³":"a","áº´":"A","áºµ":"a","áº¶":"A","áº·":"a","áº¸":"E","áº¹":"e","áºº":"E","áº»":"e","áº¼":"E","áº½":"e","áº¾":"E","áº¿":"e","á»€":"E","á»":"e","á»‚":"E","á»ƒ":"e","á»„":"E","á»…":"e","á»†":"E","á»‡":"e","á»ˆ":"I","á»‰":"i","á»Š":"I","á»‹":"i","á»Œ":"O","á»":"o","á»Ž":"O","á»":"o","á»":"O","á»‘":"o","á»’":"O","á»“":"o","á»”":"O","á»•":"o","á»–":"O","á»—":"o","á»˜":"O","á»™":"o","á»š":"O","á»›":"o","á»œ":"O","á»":"o","á»ž":"O","á»Ÿ":"o","á» ":"O","á»¡":"o","á»¢":"O","á»£":"o","á»¤":"U","á»¥":"u","á»¦":"U","á»§":"u","á»¨":"U","á»©":"u","á»ª":"U","á»«":"u","á»¬":"U","á»­":"u","á»®":"U","á»¯":"u","á»°":"U","á»±":"u","á»²":"Y","á»³":"y","á»´":"Y","á»µ":"y","á»¶":"Y","á»·":"y","á»¸":"Y","á»¹":"y","â€˜":"\'","â€™":"\'","â€œ":"\\"","â€":"\\"","â€ ":"+","â€¢":"*","â€¦":"...","â‚ ":"ecu","â‚¢":"cruzeiro","â‚£":"french franc","â‚¤":"lira","â‚¥":"mill","â‚¦":"naira","â‚§":"peseta","â‚¨":"rupee","â‚©":"won","â‚ª":"new shequel","â‚«":"dong","â‚¬":"euro","â‚­":"kip","â‚®":"tugrik","â‚¯":"drachma","â‚°":"penny","â‚±":"peso","â‚²":"guarani","â‚³":"austral","â‚´":"hryvnia","â‚µ":"cedi","â‚¸":"kazakhstani tenge","â‚¹":"indian rupee","â‚½":"russian ruble","â‚¿":"bitcoin","â„ ":"sm","â„¢":"tm","âˆ‚":"d","âˆ†":"delta","âˆ‘":"sum","âˆž":"infinity","â™¥":"love","å…ƒ":"yuan","å††":"yen","ï·¼":"rial"}'),e=JSON.parse('{"vi":{"Ä":"D","Ä‘":"d"}}');function n(n,a){if("string"!=typeof n)throw new Error("slugify: string argument expected");var r=e[(a="string"==typeof a?{replacement:a}:a||{}).locale]||{},i=n.split("").reduce((function(e,n){return e+(r[n]||t[n]||n).replace(a.remove||/[^\w\s$*_+~.()'"!\-:@]/g,"")}),"").trim().replace(/[-\s]+/g,a.replacement||"-");return a.lower?i.toLowerCase():i}return n.extend=function(e){for(var n in e)t[n]=e[n]},n},t.exports=n(),t.exports.default=n()}));async function W(t,e){const a=await new Promise((e,n)=>i.get(function(t,{player:e="192.168.86.210",port:n=1400}={}){return t=M(t,"track"),[`http://${e}:${n}`,"/getaa?s=1&u=",encodeURIComponent(["x-sonos-spotify:",encodeURIComponent(t),"?sid=9&flags=8224&sn=1"].join(""))].join("")}(t),e).once("error",n).end()).then(t=>{if(200!==t.statusCode)throw new Error(`${t.statusCode} - ${t.statusMessage}`);return t}),r=n.createWriteStream(e);await T(a,r)}async function F(t){const n=await D(`/album/${t}`);let a={...H(n),tracks:n.tracks.map(t=>function(t,e){const n={title:t.name,artist:t.artists.map(t=>t.name),trackNumber:t.number},a=K(e),r=function(t,e){return t.tracks.filter(t=>t.disc===e).length}(e,t.disc);let i="track";a>1&&(n.discNumber=t.disc,i+=t.disc);const s=r>99?3:2;return i+=t.number.toString().padStart(s,"0"),i+=".flac",n.trackTotal=r,n.trackUri=t.uri,n.file=i,n}(t,n))};const r=e.join(B.work,"work",t.replace(/.*:/,"")+".json");await C(r,JSON.stringify(a,null,2)),await function(...t){const e=s.spawn(...t);return e.done=new Promise((t,n)=>{e.once("error",n),e.on("exit",(e,a)=>{if(a)return n(new Error(a));t(e)})}),e}("vi",[r],{stdio:"inherit"}).done,a=await L(r),await _("rm",[r]);const i=e.join(B.store,a.path);if(await Y(i))throw new Error(`Already exists: ${i}`);return await _("mkdir",["-p",i]),await C(e.join(i,"metadata.json"),JSON.stringify(a,null,2)),await W(a.tracks[0].trackUri,e.join(i,"cover.jpg")),i}function Z(t){return G(t,{remove:/[^\w\s_-]/})}function H(t){const e={albumArtist:t.artist.name,album:t.name,genre:"Classical",year:t.year,path:null,albumUri:t.uri};e.path=Z(t.artist.name)+"/"+Z(t.name);const n=K(t);return n>1&&(e.discTotal=n),e}function K(t){const e=t.tracks.map(t=>t.disc).filter(Boolean);return(n=e,[...new Set(n)]).length;var n}const{FORCE_COLOR:Q,NODE_DISABLE_COLORS:V,TERM:X}=process.env,tt={enabled:!V&&"dumb"!==X&&"0"!==Q,reset:nt(0,0),bold:nt(1,22),dim:nt(2,22),italic:nt(3,23),underline:nt(4,24),inverse:nt(7,27),hidden:nt(8,28),strikethrough:nt(9,29),black:nt(30,39),red:nt(31,39),green:nt(32,39),yellow:nt(33,39),blue:nt(34,39),magenta:nt(35,39),cyan:nt(36,39),white:nt(37,39),gray:nt(90,39),grey:nt(90,39),bgBlack:nt(40,49),bgRed:nt(41,49),bgGreen:nt(42,49),bgYellow:nt(43,49),bgBlue:nt(44,49),bgMagenta:nt(45,49),bgCyan:nt(46,49),bgWhite:nt(47,49)};function et(t,e){let n,a=0,r="",i="";for(;a<t.length;a++)n=t[a],r+=n.open,i+=n.close,e.includes(n.close)&&(e=e.replace(n.rgx,n.close+n.open));return r+e+i}function nt(t,e){let n={open:`[${t}m`,close:`[${e}m`,rgx:new RegExp(`\\x1b\\[${e}m`,"g")};return function(e){return void 0!==this&&void 0!==this.has?(this.has.includes(t)||(this.has.push(t),this.keys.push(n)),void 0===e?this:tt.enabled?et(this.keys,e+""):e+""):void 0===e?function(t,e){let n={has:t,keys:e};return n.reset=tt.reset.bind(n),n.bold=tt.bold.bind(n),n.dim=tt.dim.bind(n),n.italic=tt.italic.bind(n),n.underline=tt.underline.bind(n),n.inverse=tt.inverse.bind(n),n.hidden=tt.hidden.bind(n),n.strikethrough=tt.strikethrough.bind(n),n.black=tt.black.bind(n),n.red=tt.red.bind(n),n.green=tt.green.bind(n),n.yellow=tt.yellow.bind(n),n.blue=tt.blue.bind(n),n.magenta=tt.magenta.bind(n),n.cyan=tt.cyan.bind(n),n.white=tt.white.bind(n),n.gray=tt.gray.bind(n),n.grey=tt.grey.bind(n),n.bgBlack=tt.bgBlack.bind(n),n.bgRed=tt.bgRed.bind(n),n.bgGreen=tt.bgGreen.bind(n),n.bgYellow=tt.bgYellow.bind(n),n.bgBlue=tt.bgBlue.bind(n),n.bgMagenta=tt.bgMagenta.bind(n),n.bgCyan=tt.bgCyan.bind(n),n.bgWhite=tt.bgWhite.bind(n),n}([t],[n]):tt.enabled?et([n],e+""):e+""}}var at=tt,rt=1e3,it=6e4,st=36e5,ot=24*st,ct=function(t,e){e=e||{};var n=typeof t;if("string"===n&&t.length>0)return function(t){if((t=String(t)).length>100)return;var e=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(t);if(!e)return;var n=parseFloat(e[1]);switch((e[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return 315576e5*n;case"weeks":case"week":case"w":return 6048e5*n;case"days":case"day":case"d":return n*ot;case"hours":case"hour":case"hrs":case"hr":case"h":return n*st;case"minutes":case"minute":case"mins":case"min":case"m":return n*it;case"seconds":case"second":case"secs":case"sec":case"s":return n*rt;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return n;default:return}}(t);if("number"===n&&isFinite(t))return e.long?function(t){var e=Math.abs(t);if(e>=ot)return lt(t,e,ot,"day");if(e>=st)return lt(t,e,st,"hour");if(e>=it)return lt(t,e,it,"minute");if(e>=rt)return lt(t,e,rt,"second");return t+" ms"}(t):function(t){var e=Math.abs(t);if(e>=ot)return Math.round(t/ot)+"d";if(e>=st)return Math.round(t/st)+"h";if(e>=it)return Math.round(t/it)+"m";if(e>=rt)return Math.round(t/rt)+"s";return t+"ms"}(t);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(t))};function lt(t,e,n,a){var r=e>=1.5*n;return Math.round(t/n)+" "+a+(r?"s":"")}function ut(t){ut.status(t+"\n"),ut.dirty=!1}ut.status=t=>{const e=ut.dirty?"\r[0K":"";process.stdout.write(`${e}${ut.prefix}${t}`),ut.dirty=!0},ut.prefix="";const{green:dt,cyan:ft}=at,ht=new c;function mt(t,e){ht.emit(t,e)}async function pt(t,n){t=M(t,"track");const a=n.replace(/\.flac$/,"")+".pcm";function r(t){t.curr?t.done?mt("track.capturing.done",t):mt("track.capturing.update",t):mt("track.capturing.start",e.basename(n))}await O(()=>z(t,a,{onProgress:r}),{onRetry:t=>mt("retry",t),retries:5,delay:6e4}),mt("track.converting.start"),await async function(t,e){await _("flac",["--silent","--force","--force-raw-format","--endian=little","--channels=2","--bps=16","--sample-rate=44100","--sign=signed",`--output-name=${e}`,t]),await _("rm",[t])}(a,n),mt("track.converting.done")}async function gt(t){const n=await L(e.join(t,"metadata.json"));mt("album.recording.start",n);for(const a of n.tracks){const n=e.join(t,a.file);await Y(n)||await pt(a.trackUri,n)}mt("album.recording.done")}async function bt(t){const n=await L(e.join(t,"metadata.json")),a=e.join(t,"cover.jpg"),r=await Y(a);for(const i of n.tracks){mt("track.tagging",i.file);const s=e.join(t,i.file);await P(s,n,i,r&&a)}mt("album.replayGain.start"),await async function(t){await _("metaflac",["--add-replay-gain",...t])}(n.tracks.map(n=>e.join(t,n.file))),mt("album.replayGain.done")}async function wt(t){const n=await L(e.join(t,"metadata.json")),a=e.join(B.store,n.path);mt("album.publishing.start",a),await async function(t,e){await _("mkdir",["-p",e]),await _("rsync",["--times","--recursive","--omit-dir-times",t+"/",e+"/"]),await _("rm",["-rf",t])}(t,a),mt("album.publishing.done")}async function yt(t){if((t=e.resolve(t)).startsWith(B.work))return t;const n=(await L(e.join(t,"metadata.json"))).path.replace("/","_"),a=e.join(B.work,"work",n);return mt("album.checkout.start",n),await async function(t,e){await _("mkdir",["-p",e]),await _("rsync",["--times","--recursive","--omit-dir-times",t+"/",e+"/"])}(t,a),mt("album.checkout.done",n),a}async function kt(t){const{stdout:e}=await _("id3v2",["--list",t]),n=e.split("\n");return{artist:vt("TPE1",n),album:vt("TALB",n),genre:vt("TCON",n),year:vt("TYER",n),title:vt("TIT2",n)}}function vt(t,e){const n=e.filter(e=>e.startsWith(t))[0];if(n)return n.replace(/^.*?: /,"")}async function $t(t,n){const a=t.replace(/\.mp3$/,"")+".pcm";mt("extract.mp3.track.start",e.basename(t)),await _("lame",["--silent","--decode","-t",t,a]),mt("extract.mp3.track.convert",e.basename(t)),await _("flac",["--silent","--force","--force-raw-format","--endian=little","--channels=2","--bps=16","--sample-rate=44100","--sign=signed","--output-name="+n,a]),await _("rm",[a])}ht.on("track.capturing.start",t=>{ut.prefix=`${dt(t)} `,ut.status("... ")}).on("track.capturing.update",({percent:t,taken:e,eta:n})=>ut.status(`- ${t}%  in ${ct(e)}  eta ${ct(n)}`)).on("track.capturing.done",({total:t,speed:e})=>{ut.prefix+=dt(`- ${function(t){const e=Math.round(t/1e3),n=Math.floor(e/60).toString().padStart(2,"0"),a=(e%60).toString().padStart(2,"0");return`${n}:${a}`}(1e3*t)}  at ${e.toFixed(1)}x`),ut.status(" ")}).on("track.converting.start",()=>ut.status(" ... converting")).on("track.converting.done",()=>{ut(""),ut.prefix=""}).on("track.tagging",t=>ut.status(`Tagging ${t}`)).on("album.recording.start",t=>{ut(`Recording ${ft(t.album)}`),ut(`by ${ft(t.albumArtist)}`),ut(`from ${t.albumUri}`),ut("")}).on("album.recording.done",()=>ut("")).on("album.replayGain.start",()=>ut.status("Calculating replay gain")).on("album.replayGain.done",()=>ut("Album tags written")).on("album.publishing.start",t=>ut(`Storing to ${t}`)).on("album.publishing.done",()=>ut("Stored")).on("album.checkout.start",t=>ut.status(`Copying to ${t}`)).on("album.checkout.done",t=>ut(`Copied to ${t}`)).on("album.queue.start",t=>ut(`Queue ${dt(t)}`)).on("album.queue.done",t=>ut(`\nQueued ${ft(t)} for ripping`)).on("daemon.status",t=>ut(t?`spotweb running as pid ${t}`:"spotweb not running")).on("daemon.stopped",()=>ut("spotweb stopped")).on("daemon.started",()=>ut("spotweb started")).on("retry",({delay:t,error:e})=>{console.error(`\nError occured: ${e?e.message:"Unknown"}\nWaiting ${ct(t)} to retry...`)}).on("extract.mp3.track.start",t=>ut.status(`${t} extracting`)).on("extract.mp3.track.convert",t=>ut.status(`${t} converting`)).on("extract.mp3.track.done",t=>ut(dt(t))).on("extract.mp3.album.done",()=>ut("\nExtracted")).on("extract.flac.track",t=>ut(dt(t))).on("extract.flac.album",()=>ut("\nExtracted"));const At=["TITLE","TRACKNUMBER","DISCNUMMBER","TRACKTOTAL","TOTALDISCS","ALBUM","ALBUMARTIST","YEAR","ARTIST","GENRE"];async function Et(t){const{stdout:e}=await _("metaflac",[...At.map(t=>`--show-tag=${t}`),t]),n=e.split("\n").filter(Boolean),a={};for(const t of n){const e=/^(\w+)=(.*)$/.exec(t);if(!e)continue;const n=e[1],r=e[2].trim();a[n]?Array.isArray(a[n])?a[n].push(r):a[n]=[a[n],r]:a[n]=r}return a}const xt=new A("spotrip",Ot);var Ot;xt.version("1.3.1").option("--work","The working directory structure","/home/alan/music").option("--store","The store for music","/nas/data/media/music/albums/Classical").option("--spotweb-port","The port for spotweb",39705).option("--spotweb-command","The command for spotweb","/home/alan/dev/spotweb/env/bin/python /home/alan/dev/spotweb/src/spotweb.py"),xt.command("queue <album-url>").describe("queue the album for ripping").action((async function(t){mt("album.queue.start",t=M(t,"album"));const n=await F(t),a=await yt(n),r=e.basename(a),i=e.join(B.work,"queue",r);await C(i,`spotrip rip ${a}\n`),mt("album.queue.done",r)})),xt.command("record track <track-uri> <dest>").describe("record a track").action(pt),xt.command("record album <dir>").describe("record an album").action(gt),xt.command("tag <dir>").describe("set tags for an album").action(bt),xt.command("checkout <dir>").describe("checkout a working copy of the album").action(yt),xt.command("publish <dir>").describe("publish the album").action(wt),xt.command("rip <dir>").describe("record, tag and store an album").action((async function(t){const e=await yt(t);await gt(e),await bt(e),await wt(e)})),xt.command("extract mp3 <dir>").describe("converts MP3 dir").action((async function(t){const n=await async function(t){return(await U(t)).filter(t=>t.endsWith(".mp3")).sort()}(t),a={};let r=1;for(const i of n){const s=e.join(t,i),o=s.replace(/\.mp3$/,".flac");await $t(s,o);const c=await kt(s);1===r&&(a.albumArtist=c.artist,a.album=c.album,a.genre=c.genre,a.year=c.year,a.path=G(a.albumArtist)+"/"+G(a.album),a.tracks=[]),a.tracks.push({title:c.title,artist:c.artist,trackNumber:r++,trackTotal:n.length,file:e.basename(o)}),mt("extract.mp3.track.done",i)}await C(e.join(t,"metadata.json"),JSON.stringify(a,null,2)),mt("extract.mp3.album.done")})),xt.command("extract flac <dir>").describe("converts FLAC dir").action((async function(t){const n=await async function(t){return(await U(t)).filter(t=>t.endsWith(".flac")).sort()}(t),a={};let r=1;for(const i of n){const s=e.join(t,i),o=await Et(s);1===r&&(a.albumArtist=o.ALBUMARTIST,a.album=o.ALBUM,a.genre=o.GENRE||"Classical",a.year=o.YEAR,a.path=G(a.albumArtist)+"/"+G(a.album),a.discTotal=o.DISCTOTAL,a.tracks=[]),a.tracks.push({title:o.TITLE,artist:o.ARTIST,trackNumber:r++,trackTotal:n.length,file:e.basename(s)}),mt("extract.flac.track",i)}await C(e.join(t,"metadata.json"),JSON.stringify(a,null,2)),mt("extract.flac.album")})),xt.command("daemon status").describe("report on spotweb").action((async function(){mt("daemon.status",await _("pgrep",["-fx",B["spotweb-command"]]).then(({stdout:t})=>t.trim(),t=>{if(t.code)return"";throw t}))})),xt.command("daemon stop").describe("stop spotweb").action((async function(){await async function(){await _("pkill",["-fx",B["spotweb-command"]])}(),mt("daemon.stopped")})),xt.command("daemon start").describe("start spotweb").action((async function(){await async function(){const[t,...e]=B["spotweb-command"].split(" ");s.spawn(t,e,{detached:!0,stdio:"ignore"}).unref()}(),mt("daemon.started")})),xt.command("show album <uri>").describe("show the metadata for an album").action((async function(t){t=M(t,"album");const e=await D(`/album/${t}`);console.log(JSON.stringify(e,null,2))})),xt.command("show track <uri>").describe("show the metadata for a track").action((async function(t){t=M(t,"track");const e=await D(`/track/${t}`);console.log(JSON.stringify(e,null,2))}));const jt=xt.parse(process.argv,{lazy:!0});if(jt){const{handler:t,args:e}=jt;B.set(e.pop()),t.apply(null,e).catch(t=>{console.error("An unexpected error occured"),console.error(t),process.exit(1)})}
